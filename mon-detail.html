<!DOCTYPE html>
<html lang="en">
<head data-load="/html/seo.html,/html/csslib.html">
    <style>
        .main-image {
            aspect-ratio: 1/1;
            max-height: calc(40vh);
        }
        #mon-ctn > div {
            min-width: 250px;
        }
        hr {
            border: 1px solid black;
            width: 100%;
        }
    </style>
    <title>旗章製造</title>
</head>
<body style="overflow-x: hidden;">
    
    <div data-load="/html/banner_detail.html"></div>
    
    <div data-title="body" class="container d-flex flex-wrap justify-content-center W-100 mb-5">

        <nav aria-title="breadcrumb" class="noto-sans-tc w-75 py-1">
            <ol class="breadcrumb"></ol>
        </nav>

        <div data-title="display" class="d-flex flex-wrap flex-md-nowrap justify-content-center align-items-center w-75 pt-5 my-5">
            <img class="main-image me-md-5 mb-5 mb-md-0 modal-trigger-image" data-type="mon">
            <div class="description noto-sans-tc fs-5">紋的介紹還沒完成，但或許過一段時間它就會自己長出來了。</div>
        </div>

        <span class="w-100 mb-5 my-5" id="related-entities">
            <hr class="mb-4">
            <div class="w-100 text-center fs-3 mb-4 noto-sans-tc">相關和紋</div>
        </span>

        <div data-title="mon-display" class="w-100 mb-5">
            <div class="d-flex justify-content-center flex-wrap" id="mon-ctn"></div>
        </div>

        <div data-title="neighbors" class="mw-100 mb-5">
            <div class="d-flex flex-wrap flex-md-nowrap justify-content-center">
                <span class="w-100 w-md-50 text-center my-2" id="prev-mon">
                    <a class="text-dark text-nowrap mx-2 fs-4">
                        <i class="bi bi-arrow-left-square-fill"></i>
                        <span class="noto-sans-tc text-nowrap"></span>
                    </a>
                </span>
                <span class="w-100 w-md-50 text-center my-2" id="next-mon">
                    <a class="text-dark text-nowrap mx-2 fs-4">
                        <span class="noto-sans-tc text-nowrap"></span>
                        <i class="bi bi-arrow-right-square-fill"></i>
                    </a>
                </span>
            </div>
        </div>
    </div>

    <div data-load="/html/footer.html"></div>
    <div data-load="/html/image_modal.html"></div>
    
    <!-- jquery -->
    <script src="/plugins/jquery/jquery-3.7.1.min.js"></script>
    <!-- bootstrap -->
    <script src="/plugins/bootstrap/bootstrap.min.js"></script>
    <script src="/plugins/bootstrap/bootstrap.bundle.min.js"></script>
    <!-- mon data -->
    <script src="/js/mon_data.js"></script>
    <script src="/js/load_html.js"></script>
    <script>
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);
        const monName = urlParams.get("name");

        var mon = getMonByEn(monName);
        const neighbors = getNeighborMons(monName);
        
        if (mon == null) {
            window.location.href = "/404.html";
        }
        // document.addEventListener("DOMContentLoaded", function () {
        //     setMeta(mon);
        // });
        $(function() {
            // document.title = mon.md;
            mon.desc = getMonDesc(mon.en);
            setMainImage(mon)
            setBreadcrumb(mon);
            
            $("#prev-mon").hide();
            $("#next-mon").hide();
            
            const relatedMons = getRelatedMons(monName);

            if (!relatedMons.length) {
                $("#related-entities").hide();
            }
            if (relatedMons != undefined && relatedMons.length) {
                $("div[data-title='mon-display']").addClass("mb-5");
                for (var relatedMon of relatedMons) {
                    appendImage(relatedMon, monConfig);
                }
            }
            // show modal on left click on images
            $(".modal-trigger-image").on("mousedown", function(event) {
                // only trigger on left click
                if (event.which != 1) return;
                var imgSrc = $(this).attr("src");
                $("#modal-image-src").attr("src", imgSrc);
                $("#image-modal-trigger").click();
            });
            // set neighbors
            if (neighbors.prev != null) {
                var href = `/mon-detail.html?name=${neighbors.prev.en}`;
                $("#prev-mon").show();
                $("#prev-mon > a").attr("href", href);
                $("#prev-mon > a > span").html(neighbors.prev.md);
            }
            if (neighbors.next != null) {
                var href = `/mon-detail.html?name=${neighbors.next.en}`;
                $("#next-mon").show();
                $("#next-mon > a").attr("href", href);
                $("#next-mon > a > span").html(neighbors.next.md);
            }
        });
        
        function setMainImage(mon) {
            $(".main-image").attr("src", monConfig.dir + mon.en + ".png");
            $(".main-image").attr("alt", mon.title);

            // default desc is in html

            if (mon.desc) { // if desc exists
                $(".description").html(mon.desc);
            } else {
                if (mon.desc_inherit !== true) return;
                const parentMon = getMonByEn(mon.parent);
                if (!parentMon) return;
                if (!parentMon.desc) return;
                $(".description").html(parentMon.desc); // if mon inherits desc
            }
        }

        function setBreadcrumb(mon) {
            do {
                if (mon.en === monName) {
                    $(".breadcrumb").prepend(`<li class="breadcrumb-item text-secondary">${mon.title_md}</li>`);
                } else {
                    $(".breadcrumb").prepend(`<li class="breadcrumb-item text-secondary"><a href="/mon-detail.html?name=${mon.en}" class="text-secondary">${mon.title_md}</a></li>`);
                }
                mon = getMonByEn(mon.parent);
            } while (mon !== null);
            $(".breadcrumb").prepend(`<li class="breadcrumb-item"><a href="/category-mon.html" class="text-secondary">和紋</a></li>`);
            $(".breadcrumb").prepend(`<li class="breadcrumb-item"><a href="/index.html" class="text-secondary"><i class="bi bi-house-fill"></i></a></li>`);
        }

        function setMeta(mon) {
            const imageSrc = "https://" +  window.location.host + monConfig.dir + mon.en + ".png";
            const desc = mon.desc ?? "旗章製造收錄了台灣的各式旗幟與紋章創作。";

            setSingleMeta("name", "keywords", `旗章製造,旗章,旗幟,國旗,市旗,縣旗,旗幟學,紋章,和紋,家紋,市徽,市章,縣徽,縣章,設計,${mon.md}`);
            setSingleMeta("name", "image", imageSrc);
            setSingleMeta("name", "description", desc);
            
            setSingleMeta("property", "og:title", mon.title_md);
            setSingleMeta("property", "og:description", desc);
            setSingleMeta("property", "og:description", imageSrc);
            
            setSingleMeta("name", "twitter:title", mon.title_md);
            setSingleMeta("name", "twitter:description", desc);
            setSingleMeta("name", "twitter:card", imageSrc);
        }

        function setSingleMeta(attr, attrValue, content) {
            $(`meta[${attr}="${attrValue}"]`).remove();
            $(`head`).prepend(`<meta ${attr}="${attrValue}" content="${content}">`);
        }

        function appendImage(image, config) {
            var path = config.dir + image.en + ".png";
            var text = image.title_md;
            // var childrenCount = getMonChildrenCount(image.en);
            // var childrenCountHtml = childrenCount > 0 ? `<span class="ms-2">[${childrenCount}]</span>` : "";

            $(`<div class="text-center p-3">
                    <img src="${path}" class="${config.imageClasses}" data-title="${image.en}" data-type="${config.type}" width="${config.width}" height="${config.height}">
                    <br>
                    <div class="noto-sans-tc text-secondary pt-2">
                        <a class="text-secondary" href="/mon-detail.html?name=${image.en}">${text}</a>
                    </div>
                </div>`
            ).appendTo(config.container);
        }
    </script>
</body>
</html>